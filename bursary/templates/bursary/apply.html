{% extends "bursary/base.html" %}
{% load static %}

{% block content %}
<h2>Submit Bursary Application</h2>

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div>
        <label for="id_county">County:</label>
        {{ form.county.errors }}
        {{ form.county }}
    </div>

    <div>
        <label for="id_constituency">Constituency:</label>
        {{ form.constituency.errors }}
        {{ form.constituency }}
    </div>

    <div>
        <label for="id_level_of_study">Level of Study:</label>
        {{ form.level_of_study.errors }}
        {{ form.level_of_study }}
    </div>

    <div>
        <label for="id_document">Upload Required Document:</label>
        {{ form.document.errors }}
        {{ form.document }}
    </div>

    <button type="submit">Submit Application</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    const countyField = $("#id_county");
    const constituencyField = $("#id_constituency");

    // Disable constituency initially if no county selected
    if (!countyField.val()) {
        constituencyField.prop('disabled', true);
    }

    countyField.change(function() {
        const countyId = $(this).val();
        if (countyId) {
            $.ajax({
                url: "{% url 'ajax_load_constituencies' %}",
                data: {
                    'county': countyId
                },
                success: function(data) {
                    constituencyField.empty();
                    constituencyField.append('<option value="">Select constituency</option>');
                    data.forEach(function(item) {
                        constituencyField.append('<option value="' + item.id + '">' + item.name + '</option>');
                    });
                    constituencyField.prop('disabled', false);
                },
                error: function() {
                    constituencyField.empty();
                    constituencyField.append('<option value="">Error loading constituencies</option>');
                    constituencyField.prop('disabled', true);
                }
            });
        } else {
            constituencyField.empty();
            constituencyField.append('<option value="">Select constituency</option>');
            constituencyField.prop('disabled', true);
        }
    });
});
</script>
{% endblock %}
