{% extends "bursary/base.html" %}
{% load static %}
{% block content %}

<h2>Submit Bursary Application</h2>

<!-- Success and error messages -->
{% if messages %}
    {% for message in messages %}
        <div class="alert {% if message.tags %}{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- Error styling -->
<style>
    .errorlist {
        color: red;
        margin: 0;
        padding: 0;
        list-style: none;
    }
    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
    }
    .alert.success {
        background-color: #d4edda;
        color: #155724;
    }
    .alert.error {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- ------------------------
         Location & Level
    ------------------------ -->
    <div>
        <label for="id_county">County:</label>
        {{ form.county.errors }}
        {{ form.county }}
    </div>

    <div>
        <label for="id_constituency">Constituency:</label>
        {{ form.constituency.errors }}
        {{ form.constituency }}
    </div>

    <div>
        <label for="id_level_of_study">Level of Study:</label>
        {{ form.level_of_study.errors }}
        {{ form.level_of_study }}
    </div>

    <!-- ------------------------
         Personal Details
    ------------------------ -->
    <h3><b>Personal Details</b></h3>
    <div>
        <label for="id_full_name">Full Name:</label>
        {{ form.full_name.errors }}
        {{ form.full_name }}
    </div>

    <div>
        <label>ID No:</label>
        {{ form.id_no.errors }}
        {{ form.id_no }}
        <br>
        <label>Or Birth Certificate No:</label>
        {{ form.birth_no.errors }}
        {{ form.birth_no }}
    </div>

    <div>
        <label>Upload ID Copy:</label>
        {{ form.id_copy.errors }}
        {{ form.id_copy }}
        <br>
        <label>Upload Birth Certificate:</label>
        {{ form.birth_copy.errors }}
        {{ form.birth_copy }}
    </div>

    <div>
        <label>Gender:</label>
        {{ form.gender.errors }}
        {{ form.gender }}
    </div>

    <div>
        <label>Disability:</label>
        {{ form.disability.errors }}
        {{ form.disability }}
        <br>
        <label>If Yes, details:</label>
        {{ form.disability_details.errors }}
        {{ form.disability_details }}
    </div>

    <!-- ------------------------
         Educational Details
    ------------------------ -->
    <h3><b>Educational Details</b></h3>
    <div>
        <label>Reg No:</label>
        {{ form.reg_no.errors }}
        {{ form.reg_no }}
    </div>
    <div>
        <label>School:</label>
        {{ form.school.errors }}
        {{ form.school }}
    </div>
    <div>
        <label>Course:</label>
        {{ form.course.errors }}
        {{ form.course }}
    </div>
    <div>
        <label>Year of Study:</label>
        {{ form.year_of_study.errors }}
        {{ form.year_of_study }}
    </div>
    <div>
        <label>Annual Fees Payable:</label>
        {{ form.annual_fees.errors }}
        {{ form.annual_fees }}
        <br>
        <label>Upload Current Fee Structure:</label>
        {{ form.fee_structure.errors }}
        {{ form.fee_structure }}
    </div>
    <div>
        <label>Average Academic Performance:</label>
        {{ form.academic_performance.errors }}
        {{ form.academic_performance }}
        <br>
        <label>Upload Recent Transcript:</label>
        {{ form.transcript.errors }}
        {{ form.transcript }}
    </div>

    <!-- ------------------------
         Geo Details
    ------------------------ -->
    <h3><b>Geo Details</b></h3>
    <div>
        <label>Polling Station:</label>
        {{ form.polling_station.errors }}
        {{ form.polling_station }}
    </div>
    <div>
        <label>Sub-location:</label>
        {{ form.sub_location.errors }}
        {{ form.sub_location }}
    </div>
    <div>
        <label>Location:</label>
        {{ form.location.errors }}
        {{ form.location }}
    </div>
    <div>
        <label>Ward:</label>
        {{ form.ward.errors }}
        {{ form.ward }}
    </div>

    <!-- ------------------------
         Family Details
    ------------------------ -->
    <h3><b>Family Details</b></h3>
    <div>
        <label>Parents Status:</label>
        {{ form.parents_status.errors }}
        {{ form.parents_status }}
    </div>

    <div id="parent-fields" style="display:none;">
        <label>If Parent Disabled, provide details:</label>
        {{ form.parent_disabled.errors }}
        {{ form.parent_disabled }}
        <br>
        <label>Name:</label> {{ form.disabled_parent_name.errors }} {{ form.disabled_parent_name }}
        <br>
        <label>Phone:</label> {{ form.disabled_parent_phone.errors }} {{ form.disabled_parent_phone }}
        <br>
        <label>Type of Disability:</label> {{ form.disabled_parent_type.errors }} {{ form.disabled_parent_type }}
        <br>
        <label>Upload Supporting Document:</label> {{ form.disabled_parent_doc.errors }} {{ form.disabled_parent_doc }}
    </div>

    <!-- ------------------------
         Siblings
    ------------------------ -->
    <h3><b>Siblings</b></h3>
    <div>
        <label>High School - Names:</label>
        {{ form.siblings_highschool_names.errors }} {{ form.siblings_highschool_names }}
        <br>
        <label>Amount:</label> {{ form.siblings_highschool_amount.errors }} {{ form.siblings_highschool_amount }}
    </div>
    <div>
        <label>College - Names:</label>
        {{ form.siblings_college_names.errors }} {{ form.siblings_college_names }}
        <br>
        <label>Amount:</label> {{ form.siblings_college_amount.errors }} {{ form.siblings_college_amount }}
    </div>
    <div>
        <label>University - Names:</label>
        {{ form.siblings_university_names.errors }} {{ form.siblings_university_names }}
        <br>
        <label>Amount:</label> {{ form.siblings_university_amount.errors }} {{ form.siblings_university_amount }}
    </div>

    <!-- ------------------------
         Referees
    ------------------------ -->
    <h3><b>Referees</b></h3>
    <div>
        <label>1. Name:</label> {{ form.referee1_name.errors }} {{ form.referee1_name }}
        <br>
        <label>Telephone:</label> {{ form.referee1_phone.errors }} {{ form.referee1_phone }}
    </div>
    <div>
        <label>2. Name:</label> {{ form.referee2_name.errors }} {{ form.referee2_name }}
        <br>
        <label>Telephone:</label> {{ form.referee2_phone.errors }} {{ form.referee2_phone }}
    </div>

    <!-- ------------------------
         Supporting Document
    ------------------------ -->
    <div>
        <label>Upload Other Required Document:</label>
        {{ form.document.errors }}
        {{ form.document }}
    </div>

    <button type="submit">Submit Application</button>
</form>

<!-- ------------------------
     AJAX & Dynamic JS
------------------------ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    const countyField = $("#id_county");
    const constituencyField = $("#id_constituency");
    const parentsStatus = $("#id_parents_status");
    const parentFields = $("#parent-fields");

    // Disable constituency initially if no county selected
    if (!countyField.val()) {
        constituencyField.prop('disabled', true);
    }

    countyField.change(function() {
        const countyId = $(this).val();
        if (countyId) {
            $.ajax({
                url: "{% url 'ajax_load_constituencies' %}",
                data: {'county': countyId},
                success: function(data) {
                    constituencyField.empty();
                    constituencyField.append('<option value="">Select constituency</option>');
                    data.forEach(function(item) {
                        constituencyField.append('<option value="' + item.id + '">' + item.name + '</option>');
                    });
                    constituencyField.prop('disabled', false);
                }
            });
        } else {
            constituencyField.empty();
            constituencyField.append('<option value="">Select constituency</option>');
            constituencyField.prop('disabled', true);
        }
    });

    // Show/hide parent fields dynamically
    parentsStatus.change(function() {
        const status = $(this).val();
        if(status === 'both_alive' || status === 'single_mother' || status === 'single_father' || status === 'orphan' || status === 'parent_disabled'){
            parentFields.show();
        } else {
            parentFields.hide();
        }
    }).trigger('change'); // trigger on load
});
</script>

{% endblock %}
