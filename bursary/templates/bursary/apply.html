{% extends "bursary/base.html" %}
{% load static %}

{% block content %}
<h2>Submit Bursary Application</h2>

<!-- Messages -->
{% if messages %}
  {% for message in messages %}
    <div style="padding:10px;margin-bottom:10px;
      background:{% if message.tags == 'success' %}#2ecc71{% else %}#e74c3c{% endif %};
      color:white;">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<form method="POST" enctype="multipart/form-data" id="applicationForm">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <style>
        .errorlist { color:red; list-style:none; padding:0; margin:0; }
        fieldset { margin-top:20px; padding:15px; border:1px solid #ccc; }
        legend { font-weight:bold; }
        label { display:block; margin-top:10px; }
    </style>

    <!-- COUNTY / CONSTITUENCY -->
    <label>County</label>
    {{ form.county.errors }}
    {{ form.county }}

    <label>Constituency</label>
    {{ form.constituency.errors }}
    {{ form.constituency }}

    <label>Level of Study</label>
    {{ form.level_of_study.errors }}
    {{ form.level_of_study }}

    <!-- PERSONAL DETAILS -->
    <fieldset>
        <legend>Personal Details</legend>

        <label>Full Name</label>
        {{ form.full_name.errors }}
        {{ form.full_name }}

        <label>ID Number</label>
        <input type="text" id="id_no" name="id_no">

        <label>Birth Certificate Number</label>
        <input type="text" id="birth_cert_no" name="birth_cert_no">

        <label>Upload ID / Birth Certificate</label>
        <input type="file" name="identity_document">

        <label>Gender</label>
        <input type="radio" name="gender" value="male"> Male
        <input type="radio" name="gender" value="female"> Female

        <label>Disability</label>
        <input type="radio" name="disability" value="no" checked> No
        <input type="radio" name="disability" value="yes"> Yes

        <div id="disability_fields" style="display:none;">
            <label>Type of Disability</label>
            <input type="text" name="disability_type">

            <label>Upload Supporting Evidence</label>
            <input type="file" name="disability_document">
        </div>
    </fieldset>

    <!-- EDUCATION DETAILS -->
    <fieldset>
        <legend>Educational Details</legend>

        <label>Registration Number</label>
        {{ form.admission_number.errors }}
        {{ form.admission_number }}

        <label>School</label>
        {{ form.school.errors }}
        {{ form.school }}

        <label>Course of Study</label>
        {{ form.course.errors }}
        {{ form.course }}

        <label>Year of Study</label>
        {{ form.year_of_study.errors }}
        {{ form.year_of_study }}

        <label>Annual Fees Payable</label>
        {{ form.amount_requested.errors }}
        {{ form.amount_requested }}

        <label>Upload Fee Structure</label>
        {{ form.document.errors }}
        {{ form.document }}

        <label>Average Academic Performance</label>
        <input type="radio" name="performance" value="excellent"> Excellent
        <input type="radio" name="performance" value="very_good"> Very Good
        <input type="radio" name="performance" value="good"> Good
        <input type="radio" name="performance" value="fair"> Fair
        <input type="radio" name="performance" value="poor"> Poor

        <label>Upload Recent Transcript</label>
        <input type="file" name="transcript">
    </fieldset>

    <!-- GEO DETAILS -->
    <fieldset>
        <legend>Geographical Details</legend>

        <label>Polling Station</label>
        <input type="text" name="polling_station">

        <label>Sub-location</label>
        <input type="text" name="sub_location">

        <label>Location</label>
        <input type="text" name="location">

        <label>Ward</label>
        <input type="text" name="ward">
    </fieldset>

    <!-- FAMILY DETAILS -->
    <fieldset>
        <legend>Family Details</legend>

        <label>Family Status</label>
        <input type="radio" name="family_status" value="both_alive"> Both Parents Alive
        <input type="radio" name="family_status" value="mother_only"> Mother Alive, Father Deceased
        <input type="radio" name="family_status" value="father_only"> Father Alive, Mother Deceased
        <input type="radio" name="family_status" value="single_mother"> Single Mother
        <input type="radio" name="family_status" value="single_father"> Single Father
        <input type="radio" name="family_status" value="orphan"> Total Orphan

        <div id="family_dynamic_fields" style="display:none;">
            <label>Name</label>
            <input type="text" name="parent_name">

            <label>Phone Number</label>
            <input type="text" name="parent_phone">

            <label>Occupation</label>
            <input type="text" name="parent_occupation">

            <label>ID Number</label>
            <input type="text" name="parent_id">

            <label>Burial Permit / Death Certificate Number</label>
            <input type="text" name="death_cert_no">

            <label>Upload Supporting Document</label>
            <input type="file" name="death_document">
        </div>
    </fieldset>

    <!-- SIBLINGS -->
    <fieldset>
        <legend>Number of Siblings in School</legend>

        <label>Number of Siblings</label>
        <input type="number" name="siblings_count">

        <table border="1" width="100%">
            <tr>
                <th>Name</th>
                <th>Level of Study</th>
                <th>Amount Payable</th>
            </tr>
            <tr>
                <td><input type="text" name="sibling_name[]"></td>
                <td><input type="text" name="sibling_level[]"></td>
                <td><input type="number" name="sibling_amount[]"></td>
            </tr>
        </table>
    </fieldset>

    <!-- REFEREES -->
    <fieldset>
        <legend>Referees</legend>

        <label>Referee 1 Name</label>
        <input type="text" name="referee1_name">

        <label>Referee 1 Phone</label>
        <input type="text" name="referee1_phone">

        <label>Referee 2 Name</label>
        <input type="text" name="referee2_name">

        <label>Referee 2 Phone</label>
        <input type="text" name="referee2_phone">
    </fieldset>

    <br>
    <button type="submit">Submit Application</button>
</form>

<!-- JS -->
<script>
/* Disability toggle */
document.querySelectorAll('input[name="disability"]').forEach(el => {
    el.addEventListener('change', function () {
        document.getElementById('disability_fields').style.display =
            this.value === 'yes' ? 'block' : 'none';
    });
});

/* Family status toggle */
document.querySelectorAll('input[name="family_status"]').forEach(el => {
    el.addEventListener('change', function () {
        document.getElementById('family_dynamic_fields').style.display = 'block';
    });
});

/* County â†’ Constituency AJAX (RESTORED) */
document.getElementById('id_county').addEventListener('change', function () {
    const countyId = this.value;
    const constituencySelect = document.getElementById('id_constituency');

    constituencySelect.innerHTML = '<option value="">Loading...</option>';

    fetch(`/ajax/load-constituencies/?county=${countyId}`)
        .then(response => response.json())
        .then(data => {
            constituencySelect.innerHTML = '<option value="">Select constituency</option>';
            data.forEach(item => {
                constituencySelect.innerHTML +=
                    `<option value="${item.id}">${item.name}</option>`;
            });
            constituencySelect.disabled = false;
        });
});
</script>

{% endblock %}
