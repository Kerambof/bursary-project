{% extends "bursary/base.html" %}
{% load static %}

{% block content %}
<h2>Submit Bursary Application</h2>

{% if messages %}
  {% for message in messages %}
    <div style="padding:10px;margin-bottom:10px;
      background:{% if message.tags == 'success' %}#2ecc71{% else %}#e74c3c{% endif %};
      color:white;">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<form method="POST" enctype="multipart/form-data">
{% csrf_token %}
{{ form.non_field_errors }}

<style>
.errorlist { color:red; list-style:none; padding:0; }
fieldset { margin-top:20px; padding:15px; border:1px solid #ccc; }
legend { font-weight:bold; }
label { display:block; margin-top:10px; font-weight:600; }
.hidden { display:none; }
</style>

<!-- LOCATION -->
<label>County</label>
{{ form.county.errors }}
{% if errors.county %}
  <div class="errorlist">{{ errors.county }}</div>
{% endif %}
{{ form.county }}

<label>Constituency</label>
{{ form.constituency.errors }}
{% if errors.constituency %}
  <div class="errorlist">{{ errors.constituency }}</div>
{% endif %}
{{ form.constituency }}

<label>Level of Study</label>
{{ form.level_of_study.errors }}
{% if errors.level_of_study %}
  <div class="errorlist">{{ errors.level_of_study }}</div>
{% endif %}
{{ form.level_of_study }}

<!-- PERSONAL DETAILS -->
<fieldset>
<legend>Personal Details</legend>

<label>Full Name</label>
{{ form.full_name.errors }}
{% if errors.full_name %}
  <div class="errorlist">{{ errors.full_name }}</div>
{% endif %}
{{ form.full_name }}

<label>ID Number</label>
{% if errors.id_no %}
  <div class="errorlist">{{ errors.id_no }}</div>
{% endif %}
<input type="text" name="id_no" value="{{ request.POST.id_no }}">

<label>Birth Certificate Number</label>
<input type="text" name="birth_cert_no" value="{{ request.POST.birth_cert_no }}">

<label>Upload ID / Birth Certificate</label>
{% if errors.identity_document %}
  <div class="errorlist">{{ errors.identity_document }}</div>
{% endif %}
<input type="file" name="identity_document">

<label>Gender</label>
{% if errors.gender %}
  <div class="errorlist">{{ errors.gender }}</div>
{% endif %}
<input type="radio" name="gender" value="male" {% if request.POST.gender == 'male' %}checked{% endif %}> Male
<input type="radio" name="gender" value="female" {% if request.POST.gender == 'female' %}checked{% endif %}> Female

<label>Disability</label>
<input type="radio" name="disability" value="no" {% if request.POST.disability != 'yes' %}checked{% endif %}> No
<input type="radio" name="disability" value="yes" {% if request.POST.disability == 'yes' %}checked{% endif %}> Yes

<div id="disability_fields" class="hidden">
  <label>Type of Disability</label>
  {% if errors.disability_type %}
    <div class="errorlist">{{ errors.disability_type }}</div>
  {% endif %}
  <input type="text" name="disability_type" value="{{ request.POST.disability_type }}">

  <label>Upload Disability Supporting Evidence</label>
  {% if errors.disability_document %}
    <div class="errorlist">{{ errors.disability_document }}</div>
  {% endif %}
  <input type="file" name="disability_document">
</div>
</fieldset>

<!-- EDUCATION DETAILS -->
<fieldset>
<legend>Educational Details</legend>

<label>Reg No/Admin No:</label>
{{ form.admission_number.errors }}
{% if errors.admission_number %}
  <div class="errorlist">{{ errors.admission_number }}</div>
{% endif %}
{{ form.admission_number }}

<label>School</label>
{{ form.school.errors }}
{% if errors.school %}
  <div class="errorlist">{{ errors.school }}</div>
{% endif %}
{{ form.school }}

<label>Course of Study</label>
{{ form.course.errors }}
{% if errors.course %}
  <div class="errorlist">{{ errors.course }}</div>
{% endif %}
{{ form.course }}

<label>Year of Study/ Form</label>
{{ form.year_of_study.errors }}
{% if errors.year_of_study %}
  <div class="errorlist">{{ errors.year_of_study }}</div>
{% endif %}
{{ form.year_of_study }}

<label>Annual Fees Payable</label>
{{ form.amount_requested.errors }}
{% if errors.amount_requested %}
  <div class="errorlist">{{ errors.amount_requested }}</div>
{% endif %}
{{ form.amount_requested }}

<label>Upload Current Fee Structure</label>
{{ form.document.errors }}
{% if errors.document %}
  <div class="errorlist">{{ errors.document }}</div>
{% endif %}
{{ form.document }}

<label>Average Academic Performance</label>
{% if errors.performance %}
  <div class="errorlist">{{ errors.performance }}</div>
{% endif %}
<input type="radio" name="performance" value="excellent" {% if request.POST.performance == 'excellent' %}checked{% endif %}> Excellent
<input type="radio" name="performance" value="very_good" {% if request.POST.performance == 'very_good' %}checked{% endif %}> Very Good
<input type="radio" name="performance" value="good" {% if request.POST.performance == 'good' %}checked{% endif %}> Good
<input type="radio" name="performance" value="fair" {% if request.POST.performance == 'fair' %}checked{% endif %}> Fair
<input type="radio" name="performance" value="poor" {% if request.POST.performance == 'poor' %}checked{% endif %}> Poor

<label>Upload Recent Transcript</label>
<input type="file" name="transcript">
</fieldset>

<!-- GEO DETAILS -->
<fieldset>
<legend>Geographical Details</legend>

<label>Polling Station</label>
{% if errors.polling_station %}
  <div class="errorlist">{{ errors.polling_station }}</div>
{% endif %}
<input type="text" name="polling_station" value="{{ request.POST.polling_station }}">

<label>Sub-location</label>
{% if errors.sub_location %}
  <div class="errorlist">{{ errors.sub_location }}</div>
{% endif %}
<input type="text" name="sub_location" value="{{ request.POST.sub_location }}">

<label>Location</label>
{% if errors.location %}
  <div class="errorlist">{{ errors.location }}</div>
{% endif %}
<input type="text" name="location" value="{{ request.POST.location }}">

<label>Ward</label>
{% if errors.ward %}
  <div class="errorlist">{{ errors.ward }}</div>
{% endif %}
<input type="text" name="ward" value="{{ request.POST.ward }}">
</fieldset>

<fieldset>
<legend>Family Details</legend>

<label>Family Status</label>
{% if errors.family_status %}
  <div class="errorlist">{{ errors.family_status }}</div>
{% endif %}
<input type="radio" name="family_status" value="both_alive" {% if request.POST.family_status == 'both_alive' %}checked{% endif %}> Both Parents Alive  
<input type="radio" name="family_status" value="mother_dead" {% if request.POST.family_status == 'mother_dead' %}checked{% endif %}> Mother Alive, Father Deceased  
<input type="radio" name="family_status" value="father_dead" {% if request.POST.family_status == 'father_dead' %}checked{% endif %}> Father Alive, Mother Deceased  
<input type="radio" name="family_status" value="single_mother" {% if request.POST.family_status == 'single_mother' %}checked{% endif %}> Single Mother  
<input type="radio" name="family_status" value="single_father" {% if request.POST.family_status == 'single_father' %}checked{% endif %}> Single Father  
<input type="radio" name="family_status" value="orphan" {% if request.POST.family_status == 'orphan' %}checked{% endif %}> Total Orphan

<!-- BOTH ALIVE -->
<div id="both_alive" class="hidden">
  <h4>Father Details</h4>
  <label>Father Name</label>
  {% if errors.father_name %}<div class="errorlist">{{ errors.father_name }}</div>{% endif %}
  <input type="text" name="father_name" placeholder="Enter father's full name" value="{{ request.POST.father_name }}">

  <label>Father Phone</label>
  {% if errors.father_phone %}<div class="errorlist">{{ errors.father_phone }}</div>{% endif %}
  <input type="text" name="father_phone" placeholder="Enter father's phone number" value="{{ request.POST.father_phone }}">

  <label>Father Occupation</label>
  {% if errors.father_occupation %}<div class="errorlist">{{ errors.father_occupation }}</div>{% endif %}
  <input type="text" name="father_occupation" placeholder="Enter father's occupation" value="{{ request.POST.father_occupation }}">

  <label>Father ID Number</label>
  {% if errors.father_id %}<div class="errorlist">{{ errors.father_id }}</div>{% endif %}
  <input type="text" name="father_id" placeholder="Enter father's ID number" value="{{ request.POST.father_id }}">

  <h4>Mother Details</h4>
  <label>Mother Name</label>
  {% if errors.mother_name %}<div class="errorlist">{{ errors.mother_name }}</div>{% endif %}
  <input type="text" name="mother_name" placeholder="Enter mother's full name" value="{{ request.POST.mother_name }}">

  <label>Mother Phone</label>
  {% if errors.mother_phone %}<div class="errorlist">{{ errors.mother_phone }}</div>{% endif %}
  <input type="text" name="mother_phone" placeholder="Enter mother's phone number" value="{{ request.POST.mother_phone }}">

  <label>Mother Occupation</label>
  {% if errors.mother_occupation %}<div class="errorlist">{{ errors.mother_occupation }}</div>{% endif %}
  <input type="text" name="mother_occupation" placeholder="Enter mother's occupation" value="{{ request.POST.mother_occupation }}">

  <label>Mother ID Number</label>
  {% if errors.mother_id %}<div class="errorlist">{{ errors.mother_id }}</div>{% endif %}
  <input type="text" name="mother_id" placeholder="Enter mother's ID number" value="{{ request.POST.mother_id }}">
</div>

<!-- MOTHER DEAD -->
<div id="mother_dead" class="hidden">
  <h4>Mother Details</h4>
  <label>Mother Name</label>
  {% if errors.mother_name %}<div class="errorlist">{{ errors.mother_name }}</div>{% endif %}
  <input type="text" name="mother_name" placeholder="Enter mother's full name" value="{{ request.POST.mother_name }}">

  <label>Mother Phone</label>
  {% if errors.mother_phone %}<div class="errorlist">{{ errors.mother_phone }}</div>{% endif %}
  <input type="text" name="mother_phone" placeholder="Enter mother's phone number" value="{{ request.POST.mother_phone }}">

  <label>Mother Occupation</label>
  {% if errors.mother_occupation %}<div class="errorlist">{{ errors.mother_occupation }}</div>{% endif %}
  <input type="text" name="mother_occupation" placeholder="Enter mother's occupation" value="{{ request.POST.mother_occupation }}">

  <label>Mother ID Number</label>
  {% if errors.mother_id %}<div class="errorlist">{{ errors.mother_id }}</div>{% endif %}
  <input type="text" name="mother_id" placeholder="Enter mother's ID number" value="{{ request.POST.mother_id }}">

  <label>Father Death Certificate Number</label>
  {% if errors.father_death_no %}<div class="errorlist">{{ errors.father_death_no }}</div>{% endif %}
  <input type="text" name="father_death_no" placeholder="Enter father's death certificate number" value="{{ request.POST.father_death_no }}">

  <label>Upload Father Death Certificate</label>
  {% if errors.father_death_doc %}<div class="errorlist">{{ errors.father_death_doc }}</div>{% endif %}
  <input type="file" name="father_death_doc">
</div>

<!-- FATHER DEAD -->
<div id="father_dead" class="hidden">
  <h4>Father Details</h4>
  <label>Father Name</label>
  {% if errors.father_name %}<div class="errorlist">{{ errors.father_name }}</div>{% endif %}
  <input type="text" name="father_name" placeholder="Enter father's full name" value="{{ request.POST.father_name }}">

  <label>Father Phone</label>
  {% if errors.father_phone %}<div class="errorlist">{{ errors.father_phone }}</div>{% endif %}
  <input type="text" name="father_phone" placeholder="Enter father's phone number" value="{{ request.POST.father_phone }}">

  <label>Father Occupation</label>
  {% if errors.father_occupation %}<div class="errorlist">{{ errors.father_occupation }}</div>{% endif %}
  <input type="text" name="father_occupation" placeholder="Enter father's occupation" value="{{ request.POST.father_occupation }}">

  <label>Father ID Number</label>
  {% if errors.father_id %}<div class="errorlist">{{ errors.father_id }}</div>{% endif %}
  <input type="text" name="father_id" placeholder="Enter father's ID number" value="{{ request.POST.father_id }}">

  <label>Mother Death Certificate Number</label>
  {% if errors.mother_death_no %}<div class="errorlist">{{ errors.mother_death_no }}</div>{% endif %}
  <input type="text" name="mother_death_no" placeholder="Enter mother's death certificate number" value="{{ request.POST.mother_death_no }}">

  <label>Upload Mother Death Certificate</label>
  {% if errors.mother_death_doc %}<div class="errorlist">{{ errors.mother_death_doc }}</div>{% endif %}
  <input type="file" name="mother_death_doc">
</div>

<!-- SINGLE MOTHER -->
<div id="single_mother" class="hidden">
  <h4>Mother Details</h4>
  <label>Mother Name</label>
  {% if errors.mother_name %}<div class="errorlist">{{ errors.mother_name }}</div>{% endif %}
  <input type="text" name="mother_name" placeholder="Enter mother's full name" value="{{ request.POST.mother_name }}">

  <label>Mother Phone</label>
  {% if errors.mother_phone %}<div class="errorlist">{{ errors.mother_phone }}</div>{% endif %}
  <input type="text" name="mother_phone" placeholder="Enter mother's phone number" value="{{ request.POST.mother_phone }}">

  <label>Mother Occupation</label>
  {% if errors.mother_occupation %}<div class="errorlist">{{ errors.mother_occupation }}</div>{% endif %}
  <input type="text" name="mother_occupation" placeholder="Enter mother's occupation" value="{{ request.POST.mother_occupation }}">

  <label>Mother ID Number</label>
  {% if errors.mother_id %}<div class="errorlist">{{ errors.mother_id }}</div>{% endif %}
  <input type="text" name="mother_id" placeholder="Enter mother's ID number" value="{{ request.POST.mother_id }}">
</div>

<!-- SINGLE FATHER -->
<div id="single_father" class="hidden">
  <h4>Father Details</h4>
  <label>Father Name</label>
  {% if errors.father_name %}<div class="errorlist">{{ errors.father_name }}</div>{% endif %}
  <input type="text" name="father_name" placeholder="Enter father's full name" value="{{ request.POST.father_name }}">

  <label>Father Phone</label>
  {% if errors.father_phone %}<div class="errorlist">{{ errors.father_phone }}</div>{% endif %}
  <input type="text" name="father_phone" placeholder="Enter father's phone number" value="{{ request.POST.father_phone }}">

  <label>Father Occupation</label>
  {% if errors.father_occupation %}<div class="errorlist">{{ errors.father_occupation }}</div>{% endif %}
  <input type="text" name="father_occupation" placeholder="Enter father's occupation" value="{{ request.POST.father_occupation }}">

  <label>Father ID Number</label>
  {% if errors.father_id %}<div class="errorlist">{{ errors.father_id }}</div>{% endif %}
  <input type="text" name="father_id" placeholder="Enter father's ID number" value="{{ request.POST.father_id }}">
</div>

<!-- ORPHAN -->
<div id="orphan" class="hidden">
  <label>Father Death Certificate Number</label>
  {% if errors.father_death_no %}<div class="errorlist">{{ errors.father_death_no }}</div>{% endif %}
  <input type="text" name="father_death_no" placeholder="Enter father's death certificate number" value="{{ request.POST.father_death_no }}">

  <label>Upload Father Death Certificate</label>
  {% if errors.father_death_doc %}<div class="errorlist">{{ errors.father_death_doc }}</div>{% endif %}
  <input type="file" name="father_death_doc">

  <label>Mother Death Certificate Number</label>
  {% if errors.mother_death_no %}<div class="errorlist">{{ errors.mother_death_no }}</div>{% endif %}
  <input type="text" name="mother_death_no" placeholder="Enter mother's death certificate number" value="{{ request.POST.mother_death_no }}">

  <label>Upload Mother Death Certificate</label>
  {% if errors.mother_death_doc %}<div class="errorlist">{{ errors.mother_death_doc }}</div>{% endif %}
  <input type="file" name="mother_death_doc">

  <h4>Guardian Details</h4>
  <label>Guardian Name</label>
  {% if errors.guardian_name %}<div class="errorlist">{{ errors.guardian_name }}</div>{% endif %}
  <input type="text" name="guardian_name" placeholder="Enter guardian's full name" value="{{ request.POST.guardian_name }}">

  <label>Guardian Phone</label>
  {% if errors.guardian_phone %}<div class="errorlist">{{ errors.guardian_phone }}</div>{% endif %}
  <input type="text" name="guardian_phone" placeholder="Enter guardian's phone number" value="{{ request.POST.guardian_phone }}">

  <label>Guardian Occupation</label>
  {% if errors.guardian_occupation %}<div class="errorlist">{{ errors.guardian_occupation }}</div>{% endif %}
  <input type="text" name="guardian_occupation" placeholder="Enter guardian's occupation" value="{{ request.POST.guardian_occupation }}">
</div>


<!-- SINGLE FATHER -->
<div id="single_father" class="hidden">
  <h4>Father Details</h4>
  {% if errors.father_name %}<div class="errorlist">{{ errors.father_name }}</div>{% endif %}
  <input type="text" name="father_name" value="{{ request.POST.father_name }}">
  
  {% if errors.father_phone %}<div class="errorlist">{{ errors.father_phone }}</div>{% endif %}
  <input type="text" name="father_phone" value="{{ request.POST.father_phone }}">
  
  {% if errors.father_occupation %}<div class="errorlist">{{ errors.father_occupation }}</div>{% endif %}
  <input type="text" name="father_occupation" value="{{ request.POST.father_occupation }}">
  
  {% if errors.father_id %}<div class="errorlist">{{ errors.father_id }}</div>{% endif %}
  <input type="text" name="father_id" value="{{ request.POST.father_id }}">
</div>

<!-- ORPHAN -->
<div id="orphan" class="hidden">
  <label>Father Death Certificate Number</label>
  <input type="text" name="father_death_no" value="{{ request.POST.father_death_no }}">
  <label>Upload Father Death Certificate</label>
  <input type="file" name="father_death_doc">

  <label>Mother Death Certificate Number</label>
  <input type="text" name="mother_death_no" value="{{ request.POST.mother_death_no }}">
  <label>Upload Mother Death Certificate</label>
  <input type="file" name="mother_death_doc">

  <h4>Guardian Details</h4>
  {% if errors.guardian_name %}<div class="errorlist">{{ errors.guardian_name }}</div>{% endif %}
  <input type="text" name="guardian_name" value="{{ request.POST.guardian_name }}">
  
  {% if errors.guardian_phone %}<div class="errorlist">{{ errors.guardian_phone }}</div>{% endif %}
  <input type="text" name="guardian_phone" value="{{ request.POST.guardian_phone }}">
  
  {% if errors.guardian_occupation %}<div class="errorlist">{{ errors.guardian_occupation }}</div>{% endif %}
  <input type="text" name="guardian_occupation" value="{{ request.POST.guardian_occupation }}">
</div>

</fieldset>

<!-- Family Section JS -->
<script>
const familySections = ['both_alive','mother_dead','father_dead','single_mother','single_father','orphan'];
const familyRadios = document.querySelectorAll('input[name="family_status"]');

function showFamilySection(value) {
  familySections.forEach(id => document.getElementById(id).classList.add('hidden'));
  const section = document.getElementById(value);
  if(section) section.classList.remove('hidden');
}

// Listen for changes
familyRadios.forEach(radio => {
  radio.addEventListener('change', () => showFamilySection(radio.value));
});

// Show section on page load if a value was previously selected
window.addEventListener('DOMContentLoaded', () => {
  const checkedRadio = document.querySelector('input[name="family_status"]:checked');
  if(checkedRadio) {
    showFamilySection(checkedRadio.value);
  }
});
</script>

<!-- SIBLINGS -->
<fieldset>
<legend>Number of Siblings in School</legend>
<label>Number of Siblings</label>
{% if errors.siblings_count %}
  <div class="errorlist">{{ errors.siblings_count }}</div>
{% endif %}
<input type="number" id="siblings_count" name="siblings_count" min="0" value="{{ request.POST.siblings_count }}">

<table border="1" cellpadding="8" cellspacing="0" style="margin-top:15px;width:100%;">
  <thead>
    <tr>
      <th>Sibling Name</th>
      <th>Institution</th>
      <th>Amount Payable Per Year</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="siblings_table_body">
  </tbody>
</table>

<button type="button" id="add_sibling_btn" style="margin-top:10px;">
  Add Sibling
</button>
</fieldset>

<!-- REFEREES -->
<fieldset>
<legend>Referees</legend>
<label>Referee 1 Name</label>
{% if errors.referee1_name %}<div class="errorlist">{{ errors.referee1_name }}</div>{% endif %}
<input type="text" name="referee1_name" value="{{ request.POST.referee1_name }}">
<label>Referee 1 Phone</label>
{% if errors.referee1_phone %}<div class="errorlist">{{ errors.referee1_phone }}</div>{% endif %}
<input type="text" name="referee1_phone" value="{{ request.POST.referee1_phone }}">

<label>Referee 2 Name</label>
{% if errors.referee2_name %}<div class="errorlist">{{ errors.referee2_name }}</div>{% endif %}
<input type="text" name="referee2_name" value="{{ request.POST.referee2_name }}">
<label>Referee 2 Phone</label>
{% if errors.referee2_phone %}<div class="errorlist">{{ errors.referee2_phone }}</div>{% endif %}
<input type="text" name="referee2_phone" value="{{ request.POST.referee2_phone }}">
</fieldset>

<button type="submit">Submit Application</button>
</form>

<script>
/* Disability toggle */
document.querySelectorAll('input[name="disability"]').forEach(r=>{
  r.addEventListener('change',()=>{
    document.getElementById('disability_fields')
      .classList.toggle('hidden', r.value === 'no');
  });
});

/* Family logic */
const sections=['both_alive','mother_dead','father_dead','single_mother','single_father','orphan'];
document.querySelectorAll('input[name="family_status"]').forEach(r=>{
  r.addEventListener('change',()=>{
    sections.forEach(id=>document.getElementById(id).classList.add('hidden'));
    document.getElementById(r.value).classList.remove('hidden');
  });
});

/* County â†’ Constituency */
document.getElementById('id_county').addEventListener('change',function(){
  fetch(`/ajax/load-constituencies/?county=${this.value}`)
  .then(r=>r.json())
  .then(data=>{
    const c=document.getElementById('id_constituency');
    c.innerHTML='<option value="">Select constituency</option>';
    data.forEach(i=>c.innerHTML+=`<option value="${i.id}">${i.name}</option>`);
    c.disabled=false;
  });
});

const tableBody = document.getElementById('siblings_table_body');
const siblingsCountInput = document.getElementById('siblings_count');
const addBtn = document.getElementById('add_sibling_btn');

function updateSiblingCount() {
  siblingsCountInput.value = tableBody.children.length;
}

addBtn.addEventListener('click', () => {
  const row = document.createElement('tr');

  row.innerHTML = `
    <td><input type="text" name="sibling_name[]" required></td>
    <td><input type="text" name="sibling_institution[]" required></td>
    <td><input type="number" name="sibling_amount[]" required></td>
    <td>
      <button type="button" class="remove_btn">Remove</button>
    </td>
  `;

  row.querySelector('.remove_btn').addEventListener('click', () => {
    row.remove();
    updateSiblingCount();
  });

  tableBody.appendChild(row);
  updateSiblingCount();
});
</script>

{% endblock %}
