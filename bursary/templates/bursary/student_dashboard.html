{% extends 'bursary/base.html' %}

{% block content %}
<h2>Welcome, {{ request.user.first_name }}</h2>
<p><a href="{% url 'student_logout' %}">Logout</a></p>

<!-- Messages -->
{% if messages %}
  {% for message in messages %}
    <div 
      style="padding: 10px; margin-bottom: 10px; border-radius: 5px;
             {% if message.tags == 'success' %}background-color: #d4edda; color: #155724;{% endif %}
             {% if message.tags == 'error' %}background-color: #f8d7da; color: #721c24;{% endif %}
             {% if message.tags == 'info' %}background-color: #d1ecf1; color: #0c5460;{% endif %}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<h3>Your Applications</h3>

{% if applications %}
<table border="1" cellpadding="5" style="border-collapse: collapse; width: 100%;">
    <tr style="background-color: #f2f2f2;">
        <th>Admission Number</th>
        <th>Full Name</th>
        <th>School</th>
        <th>Course</th>
        <th>Level of Study</th>
        <th>County</th>
        <th>Constituency</th>
        <th>Annual fee</th>
        <th>Status</th>
        <th>Date Applied</th>
    </tr>
    {% for app in applications %}
    <tr>
        <td>{{ app.admission_number }}</td>
        <td>{{ app.full_name }}</td>
        <td>{{ app.school }}</td>
        <td>{{ app.course }}</td>
        <td>{{ app.level_of_study.name }}</td>
        <td>{{ app.county.name }}</td>
        <td>{{ app.constituency.name }}</td>
        <td>{{ app.annual_fee }}</td>
        <td>{{ app.get_status_display }}</td>
        <td>{{ app.created_at|date:"M d, Y H:i" }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>You have not submitted any applications yet.</p>
{% endif %}

<!-- Apply Button Logic: Disabled if there is a pending application -->
{% if applications %}
    {% with applications|dictsortreversed:"created_at"|first as latest_app %}
        {% if latest_app.status == "pending" %}
            <p style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba;">
                You already have a pending application. You can only apply once per year. Please wait for it to be processed.
            </p>
            <p>
                <button style="font-weight: bold; text-decoration: underline; color: gray; cursor: not-allowed;" disabled>
                    Apply for Bursary (Pending Application)
                </button>
            </p>
        {% else %}
            <p>
                <a href="{% url 'apply' %}" style="font-weight: bold; text-decoration: underline;">
                    Apply for Bursary
                </a>
            </p>
        {% endif %}
    {% endwith %}
{% else %}
    <p>
        <a href="{% url 'apply' %}" style="font-weight: bold; text-decoration: underline;">
            Apply for Bursary
        </a>
    </p>
{% endif %}

{% endblock %}
